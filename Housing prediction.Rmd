---
title: "Housing prediction"
author: "Thuy Nguyen"
date: "5/16/2022"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message= F, warning= F, echo=FALSE}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(corrplot)
library(glmnet)
```



```{r, echo=FALSE}
colClasses <- c(ï..Order = "integer",
                 PID      = "integer",     
                MS.SubClass = "factor",
                MS.Zoning = "factor",
                Lot.Frontage = "numeric",
                Lot.Area = "numeric",
                Street = "factor",
                Alley = "factor",
                Lot.Shape = "factor",
                Land.Contour = "factor",
                Utilities = "factor",
                Lot.Config = "factor",
                Land.Slope = "factor",
                Neighborhood = "factor",
                Condition.1 = "factor",
                Condition.2 = "factor",
                Bldg.Type = "factor",
                House.Style = "factor",
                Overall.Qual = "factor",
                Overall.Cond = "factor",
                Year.Built = "numeric",
                Year.Remod.Add = "numeric",
                Roof.Style = "factor",
                Roof.Matl = "factor",
                Exterior.1st = "factor",
                Exterior.2nd = "factor",
                Mas.Vnr.Type = "factor",
                Mas.Vnr.Area = "numeric",
                Exter.Qual = "factor",
                Exter.Cond = "factor",
                Foundation = "factor",
                Bsmt.Qual = "factor",
                Bsmt.Cond = "factor",
                Bsmt.Exposure = "factor",
                BsmtFin.Type.1 = "factor",
                BsmtFin.SF.1 = "numeric",
                BsmtFin.Type.2 = "factor",
                BsmtFin.SF.2 = "numeric",
                Bsmt.Unf.SF = "numeric",
                Total.Bsmt.SF = "numeric",
                Heating = "factor",
                Heating.QC = "factor",
                Central.Air = "factor",
                Electrical = "factor",
                X1st.Flr.SF = "numeric",
              "X2nd.Flr.SF" = "numeric",
                Low.Qual.Fin.SF = "numeric",
                Gr.Liv.Area = "numeric",
                Bsmt.Full.Bath = "factor", # Has NA's
                Bsmt.Half.Bath = "factor", #
                Full.Bath = "factor",
                Half.Bath = "factor",
                Bedroom.AbvGr = "factor",
                Kitchen.AbvGr = "factor",
                Kitchen.Qual = "factor",
                TotRms.AbvGrd = "numeric",
                Functional = "factor",
                Fireplaces = "factor",
                Fireplace.Qu = "factor",
                Garage.Type = "factor",
                Garage.Yr.Blt = "numeric", #has NA
                Garage.Finish = "factor",
                Garage.Cars = "factor", #?
                Garage.Area = "numeric",
                Garage.Qual = "factor",
                Garage.Cond = "factor",
                Paved.Drive = "factor",
                Wood.Deck.SF = "numeric",
                Open.Porch.SF = "numeric",
                Enclosed.Porch = "numeric",
                "X3Ssn.Porch" = "numeric",
                Screen.Porch = "numeric",
                Pool.Area = "numeric",
                Pool.QC = "factor",
                Fence = "factor",
                Misc.Feature = "factor",
                Misc.Val = "numeric",
                Mo.Sold = "factor",
                Yr.Sold = "numeric",
                Sale.Type = "factor",
                Sale.Condition = "factor",
                SalePrice = "numeric"
                )
house <- read.csv("AmesHousing.csv", na.strings = "", colClasses  = colClasses )
house <- house[, !(colnames(house) %in% c("ï..Order", "PID"))]
house_copy <- house


```

# 1. Missing values

```{r, echo=FALSE}
house %>% summarise(n_obs = sum(complete.cases(house)), n_missing =nrow(house) - n_obs , string_NA = sum(sapply(house_copy, 
                                   function(x){!is.na(x) & x == "NA"})))
par(mfrow = c(1,2))
summary(house[complete.cases(house), "SalePrice"])
summary(house[!complete.cases(house), "SalePrice"])

t <- house[,sapply(house, function(x){sum(is.na(x)) >0})]

for(i in 1:ncol(t)) t[[i]]<- ifelse(is.na(t[[i]]),1,0)
t<- cbind(t, house$SalePrice)
par(mfrow=c(8,3))
par(mar=rep(1,4))
for (i in 1:(ncol(t)-1)){
  boxplot(t$`house$SalePrice`~ t[[i]], xlab =  colnames(t)[i], ylab = "SalePrice")
}
```


## 1.1 Na values are factor level

## Na values are factor level at some columns(following description): NA means none
 - Alley 
 - Bsmt.Qual
 - Bsmt.Cond
 - Bsmt.Exposure
 - BsmtFin.Type.1
 - BsmtFin.Type.2
 - Garage.Type
 - Garage.Finish
 - Garage.Qual
 - Garage.Cond
 - FireplaceQu (Fireplace quality) 
 - PoolQC 
 - Fence 
 - MiscFeature 

```{r, echo=FALSE}

col_na <- names(house_copy)[sapply(house_copy, 
                                   function(x){sum(!is.na(x) & x == "NA") >0})]


na_desc <- NULL
for (i in col_na){
  na_desc <- c(na_desc, 
               rep(i,sum(!is.na(house_copy[,i]) & house_copy[,i]=="NA")))
}


ggplot(aes(as.factor(na_desc), fill = as.factor(na_desc)), data = as.data.frame(na_desc)) + geom_bar() + ggtitle("NA values with description") + xlab("Columns with more than 4 NA") +theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```

## Fill in None for these columns

```{r}

house[, col_na] <-data.frame(lapply(house[,col_na],
                                    function(x)as.factor(ifelse(x == 'NA', "None", levels(x)[x]))))
```

## 1.2 Real missing data

```{r, echo=FALSE}


miss.col <- names(house)[sapply(house_copy, function(x){sum(is.na(x)) >0})]

for(i in miss.col){
  print(paste0(i, " has " , sum(is.na(house_copy[i])), " NAs"))
}



na_vec4 <- NULL
for (i in miss.col){
    if (sum(is.na(house_copy[i])) <= 4) 
      na_vec4 <-c(na_vec4, rep("others",sum(is.na(house_copy[i]))))
      
    else 
      na_vec4 <- c(na_vec4, rep(i,sum(is.na(house_copy[i]))))
}

ggplot(data = as.data.frame(na_vec4),
       aes(as.factor(na_vec4), fill = as.factor(na_vec4))) + geom_bar() + 
      ggtitle("Missing data chart") + 
      xlab("Columns with more than 4 missing data") + 
      theme(axis.title.x=element_blank(),
            axis.text.x=element_blank(),
            axis.ticks.x=element_blank())

```



## 1.3 Impute missing data

a. MasVnrArea, Mas.VN.Area are lost together. Fill in None and 0 corresponding
```{r}

house$Mas.Vnr.Area[is.na(house$Mas.Vnr.Area)] <- 0
house$Mas.Vnr.Type[is.na(house$Mas.Vnr.Type)] <- "None"

```

b. Garage: No garage means no garage year built

```{r, echo=FALSE}
garage <- (house_copy %>%dplyr::select(starts_with("Garage")))[is.na(house_copy$Garage.Yr.Blt),]
garage[1:5,1:5]
fac <- Filter(is.factor, garage)
numer <- garage[, !(colnames(garage) %in% names(fac))]

for (i in 1:nrow(house)){
  if (is.na(house$Garage.Yr.Blt[i]) & 
      house$Garage.Type[i]=="None" &
      house$Garage.Finish[i] =="None" & house$Garage.Qual[i]=="None" & house$Garage.Cond[i] =="None" & house$Garage.Cars[i] ==0 & house$Garage.Area[i] ==0)
    house$Garage.Yr.Blt[i] <- 0
  else NA

}
(house %>% dplyr::select(starts_with("Garage")))[is.na(house$Garage.Yr.Blt),1:5]
```

c. Checking missing after imputations

```{r, echo=FALSE}

for(i in miss.col){
  print(paste0(i, " has " , sum(is.na(house[[i]])), " NAs"))
}

```



d. Create new columns: 

- time_Sale = Yr.Sold -Year.Built
- time_Garage = Yr.Sold - Garage.Yr.Blt
- time_remodel = Yr.Sold- Year.Remod.Add

Delete year sold, year build, year remodel, garage year built
```{r}
house$timeSale <- house$Yr.Sold -house$Year.Built
house$timeGarage <- house$Yr.Sold - house$Garage.Yr.Blt
house$timeremodel <- house$Yr.Sold- house$Year.Remod.Add
#remove id, year built, year sold
new_house <- house[, !(names(house) %in% c("Yr.Sold","Year.Built", "Garage.Yr.Blt", "Year.Remod.Add"))] 
head(new_house[, 74:ncol(new_house)])
```

e. Compute 490 NAs in Lot Frontage by using linear regression


1. Split data into factor dataset and numeric dataset

```{r, echo = FALSE}
fac_col <-Filter(is.factor,new_house)
head(fac_col[,1:6])
numeric_col <- new_house[, !(colnames(new_house) %in% names(Filter(is.factor,new_house)))]
head(numeric_col[,1:6])
```

2. create dummy variable for missing column Lot.Frontage

```{r, echo=FALSE}

missing <- as.integer(is.na(new_house$Lot.Frontage))
table(missing)
```

3. Box-plots of missing vs numeric columns

```{r, echo=FALSE, warning=FALSE, message=FALSE}
par(mfrow=c(7,4))
par(mar=rep(1,4))

for (i in colnames(numeric_col[,-c(1)])){
  boxplot(numeric_col[,i]~ missing, ylab = i)
}


```

4. Missing vs categorical variables

```{r, echo=FALSE, warning=FALSE, message=FALSE}

temp <- cbind(missing, fac_col)


par(mfrow=c(2,2))
par(mar=rep(1,4))

for (i in colnames(fac_col)[1:2]){

plot(ggplot(aes( temp[,i], fill = as.factor(missing)), data = temp) +geom_bar( aes(as.integer(temp[,i]), ..prop..))+ xlab(i))

}






```
5. Conclusions:

We find no pattern in missing data, so we assume that the missingness is completely random. 

There are several ways too treat the missing at completely random:

1. Use the complete cases
2. Delete the whole column
3. Multiple imputation

```{r, echo=FALSE}
ggplot(aes(y = log(SalePrice),x= log(Lot.Frontage)), data = new_house) + geom_point() + geom_smooth()
```

6. Comments:

The scatter plot of log(Sale Price) vs. log(Lot Frontage) indicates a flat trend in their relationship. And because the missing in Lot Frontage is random, those values should not be systematically different from the available data. Therefore, we will execute Lot Frontage from the prediction model.




```{r}
library(fastDummies)

data <- new_house[complete.cases(new_house),]

new_fac.col <- Filter(is.factor,data)
dum_fac <- list()
for (i in 1:ncol(new_fac.col)){
  tempt <- dummy_cols(new_fac.col[[i]], remove_selected_columns = TRUE)
  colnames(tempt) <- sapply(levels(new_fac.col[[i]]), function(x) {
                        paste0(colnames(new_fac.col)[i],".", x)})
  dum_fac <- c(dum_fac, tempt)
 
}
dum_fac <- as.data.frame(dum_fac)
numeric.col <- data[, !(colnames(data) %in% names(Filter(is.factor,data)))]
X <- cbind(numeric.col,dum_fac)



y <- X$SalePrice
X <- X[, !(colnames(X) %in% "SalePrice")]

set.seed(1234)
train_row <- sample(1:nrow(X), 0.8 *nrow(X))

x.train <-data.matrix(X[train_row,])
x.test <- data.matrix(X[-train_row,])

y.train <- y[train_row]
y.test <- y[-train_row]
```

```{r}


set.seed(12345)
foldid <- as.integer(cut(sample(1:nrow(x.train)), breaks = 10, labels= 1:10))

list.fits <- list()
results <- data.frame()

for (i in 0:10){
  fit.name <- paste0("alpha", i/10)
  list.fits[[fit.name]] <- cv.glmnet(x.train, 
                                     y.train, 
                                     type.measure = "mse", 
                                     alpha = i/10, 
                                  family = "gaussian", foldid = foldid)
  mse <- min(list.fits[[fit.name]]$cvm)
  temp <- data.frame(alpha = i/10, mse = mse)
  results <- rbind(results, temp)
}
results


ggplot(aes(alpha,mse), data = results) + geom_point()+geom_line()

```

Comments:

$\alpha = 0$ yields the smallest mse. We will use this value of $\alpha$ to build our prediction model.

```{r}




cv <- cv.glmnet(x.train, y.train,
                type.measure = "mse", 
                alpha = 1, 
                family = "gaussian", foldid = foldid)


fit <- glmnet(x.train, y.train, alpha= 1, lambda = cv$lambda.min)


pred <- predict(fit, x.test)
fit$beta

t <-data.frame(y_test = y.test, y_pred= pred, percent_diff= (abs(y.test - pred)/y.test))


cut.diff <- (cut(t$s0.1, breaks = c(0,.1,.15,.2,.25,.5,1,3)))

height <- sapply(split(t$s0.1, cut.diff), function(x) {length(x)/length(t$s0.1)})
barplot(height,main = "Absolute Percentage Error")

boxplot(t$s0.1, main = "Histogram of percentage of abs error")
summary(t$s0.1)
mean(t$s0.1)
hist(t$s0.1)
```

```{r}
X2 <- data.matrix(X)
library(HDCI)
bootLasso(X2,y, B=1000)$interval

```











